<!doctype html>
<html lang="nl">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Warmtekamer – 3D Viewer</title>
  <style>
    html,body{height:100%;margin:0;background:#0c0f14;color:#e6e6e6;font-family:system-ui,Segoe UI,Roboto,Arial}
    #app{position:fixed;inset:0}
    .topbar{position:fixed;left:12px;top:12px;z-index:10;background:rgba(20,24,33,.65);
      border:1px solid rgba(255,255,255,.08);padding:8px 10px;border-radius:10px;font-size:12px}
    .topbar code{background:#101420;border:1px solid rgba(255,255,255,.08);padding:1px 5px;border-radius:6px}
    .btns{position:fixed;right:12px;top:12px;z-index:10;display:flex;gap:8px}
    button{background:#1a2131;color:#e6eefc;border:1px solid #2b3a58;border-radius:10px;padding:8px 12px;cursor:pointer}
    .hint{position:fixed;left:12px;bottom:12px;font-size:12px;color:#a9b7d9}
    .ok{color:#9cffac}.bad{color:#ff9c9c}
  </style>
</head>
<body>
  <div id="app"></div>
  <div class="topbar">Model: <code id="modelName">models/warmtekamer.3mf</code> • Status: <span id="status">init…</span></div>
  <div class="btns">
    <button id="fitBtn">Fit</button>
    <button id="wireBtn">Wireframe</button>
  </div>
  <div class="hint">Sleep = draaien · Scroll = zoomen · Rechtsklik = pannen</div>

  <script type="module">
    // ----- LAADPAD (niets aanpassen): we gaan uit van /models/ naast index.html
    const PRIMARY = 'models/warmtekamer.3mf';
    const FALLBACK_STL = 'models/warmtekamer.stl';

    const statusEl = document.getElementById('status');
    const nameEl   = document.getElementById('modelName');

    import * as THREE from 'https://unpkg.com/three@0.160.1/build/three.module.js';
    import { OrbitControls } from 'https://unpkg.com/three@0.160.1/examples/jsm/controls/OrbitControls.js';
    import { RoomEnvironment } from 'https://unpkg.com/three@0.160.1/examples/jsm/environments/RoomEnvironment.js';
    import { ThreeMFLoader } from 'https://unpkg.com/three@0.160.1/examples/jsm/loaders/3MFLoader.js';
    import { STLLoader }     from 'https://unpkg.com/three@0.160.1/examples/jsm/loaders/STLLoader.js';

    // --- Renderer/scene/camera
    const container = document.getElementById('app');
    const renderer = new THREE.WebGLRenderer({antialias:true});
    renderer.setPixelRatio(Math.min(devicePixelRatio, 1.75));
    renderer.setSize(innerWidth, innerHeight);
    renderer.outputColorSpace = THREE.SRGBColorSpace;
    renderer.toneMapping = THREE.ACESFilmicToneMapping;
    container.appendChild(renderer.domElement);

    const scene = new THREE.Scene();
    scene.background = new THREE.Color(0x0c0f14);
    const camera = new THREE.PerspectiveCamera(55, innerWidth/innerHeight, 0.001, 100000);
    camera.position.set(2.8,1.8,2.8);
    const controls = new OrbitControls(camera, renderer.domElement);
    controls.enableDamping = true;

    const pmrem = new THREE.PMREMGenerator(renderer);
    scene.environment = pmrem.fromScene(new RoomEnvironment(), 0.05).texture;
    scene.add(new THREE.HemisphereLight(0xffffff,0x111122,0.6));
    const dl = new THREE.DirectionalLight(0xffffff,0.9); dl.position.set(5,8,4); scene.add(dl);

    const root = new THREE.Group(); scene.add(root);
    let wire = false;

    // --- Helpers
    const setStatus = (t, ok=true)=>{ statusEl.textContent=t; statusEl.className=ok?'ok':'bad'; };
    function bounds(obj){ const b=new THREE.Box3().setFromObject(obj);
      const s=new THREE.Vector3(), c=new THREE.Vector3(); b.getSize(s); b.getCenter(c);
      return {b,size:s,center:c,radius:Math.max(s.x,s.y,s.z)*0.5||1e-6}; }
    function centerPivot(obj){ const {center}=bounds(obj); obj.position.sub(center); }
    function normalizeScale(obj,target=1){ const {radius}=bounds(obj);
      if(!isFinite(radius)||radius===0) return;
      if(radius<0.001||radius>100){ const k=target/radius; obj.scale.setScalar(k); } }
    function fit(obj,pad=1.3){ const {radius}=bounds(obj);
      const fov=camera.fov*Math.PI/180, dist=(radius*pad)/Math.sin(fov/2);
      const dir=new THREE.Vector3(1,0.6,1).normalize();
      const c=new THREE.Vector3(); new THREE.Box3().setFromObject(obj).getCenter(c);
      controls.target.copy(c); camera.position.copy(c).addScaledVector(dir,dist);
      camera.near=Math.max(dist/1000,0.001); camera.far=dist*50+radius*10; camera.updateProjectionMatrix(); }
    function applySTLMat(obj){
      const mat=new THREE.MeshStandardMaterial({color:0xbec7d5,metalness:.15,roughness:.35,side:THREE.DoubleSide});
      obj.traverse(o=>{ if(o.isMesh) o.material=mat; });
    }

    const load3MF = url => new Promise((res,rej)=> new ThreeMFLoader().load(url,res,undefined,rej));
    const loadSTL = url => new Promise((res,rej)=> new STLLoader().load(url,g=>{
      if(!g.hasAttribute('normal')) g.computeVertexNormals(); res(new THREE.Mesh(g)); },undefined,rej));

    async function exists(relPath){
      const abs = new URL(relPath, document.baseURI).href;
      const r = await fetch(abs,{method:'GET'});
      if(!r.ok) return null;
      return abs;
    }

    async function loadModel(){
      // 1) Probeer 3MF
      let abs = await exists(PRIMARY);
      if (abs){
        nameEl.textContent = PRIMARY; setStatus('Laden (3mf)…');
        const obj = await load3MF(abs);
        // Fusion 3MF is in millimeters → schaalslag
        obj.scale.setScalar(0.001);
        normalizeScale(obj,1.0); centerPivot(obj);
        return obj;
      }
      // 2) Fallback naar STL (alleen als aanwezig)
      abs = await exists(FALLBACK_STL);
      if (abs){
        nameEl.textContent = FALLBACK_STL; setStatus('Laden (stl)…');
        const obj = await loadSTL(abs);
        applySTLMat(obj);
        normalizeScale(obj,1.0); centerPivot(obj);
        return obj;
      }
      throw new Error('Geen model gevonden. Plaats warmtekamer.3mf in /models/');
    }

    (async ()=>{
      try{
        const obj = await loadModel();
        root.add(obj);
        fit(root,1.4);
        setStatus('Gereed', true);
      }catch(e){
        console.error(e);
        setStatus('FOUT: ' + (e?.message||e), false);
        // fallback visual zodat het nooit leeg is
        const m=new THREE.Mesh(new THREE.BoxGeometry(1,1,1),
          new THREE.MeshStandardMaterial({color:0x66aaff,metalness:.2,roughness:.4}));
        root.add(m); fit(root,1.4); (function spin(){ m.rotation.y+=0.01; requestAnimationFrame(spin); })();
      }
    })();

    // UI & render
    document.getElementById('fitBtn').onclick = ()=> fit(root,1.2);
    document.getElementById('wireBtn').onclick= ()=>{
      wire=!wire; root.traverse(o=>{ if(o.isMesh&&o.material) o.material.wireframe=wire; });
    };
    addEventListener('resize', ()=>{
      camera.aspect=innerWidth/innerHeight; camera.updateProjectionMatrix();
      renderer.setSize(innerWidth,innerHeight);
    });
    (function animate(){ requestAnimationFrame(animate); controls.update(); renderer.render(scene,camera); })();
    addEventListener('error', e=> setStatus('JS error: '+e.message,false));
  </script>
</body>
</html>
